import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { Box, Typography, Container, Grid, Card, CardMedia, CardContent, CircularProgress, Button, CardActions, IconButton, Tooltip, Dialog, DialogTitle, DialogContent, DialogActions, Table, TableBody, TableCell, TableContainer, TableRow, Divider } from '@mui/material';
import AddShoppingCartIcon from '@mui/icons-material/AddShoppingCart';
import ArrowForwardIcon from '@mui/icons-material/ArrowForward';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import LoginIcon from '@mui/icons-material/Login';
import InfoIcon from '@mui/icons-material/Info';
import CloseIcon from '@mui/icons-material/Close';
import { useCart } from '../../context/CartContext';
import { useAuth } from '../../context/AuthContext';
import { useNavigate } from 'react-router-dom';

// Define predefined categories
const categories = {
  'gpu': 'Tarjetas Gráficas',
  'cpu': 'Procesadores',
  'motherboard': 'Placas Base',
  'ram': 'Memoria RAM',
  'storage': 'Discos Duros',
  'cooling': 'Refrigeración',
  'psu': 'Fuentes de Alimentación'
};

const ComponentsPage = () => {
  const [components, setComponents] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [cartMessage, setCartMessage] = useState('');
  const [showCartMessage, setShowCartMessage] = useState(false);
  const [selectedComponent, setSelectedComponent] = useState(null);
  const [openSpecsDialog, setOpenSpecsDialog] = useState(false);
  // States for carousel by category
  const [carouselIndexes, setCarouselIndexes] = useState({});
  const { addToCart } = useCart();
  const { isAuthenticated } = useAuth();
  const navigate = useNavigate();
  
  // Number of components to show per page in the carousel
  const maxItemsPerPage = 4;

  useEffect(() => {
    const fetchComponents = async () => {
      try {
        setLoading(true);
        const response = await axios.get('http://localhost:5000/api/components');
        setComponents(response.data);
        setLoading(false);
      } catch (err) {
        console.error('Error fetching components:', err);
        setError('Error al cargar los componentes. Por favor, inténtelo de nuevo más tarde.');
        setLoading(false);
      }
    };

    fetchComponents();
  }, []);
  
  // Effect to hide cart message after 3 seconds
  useEffect(() => {
    if (showCartMessage) {
      const timer = setTimeout(() => {
        setShowCartMessage(false);
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [showCartMessage]);

  // Function to add a product to cart using context
  const handleAddToCart = async (component) => {
    // Check if user is authenticated
    if (!isAuthenticated) {
      // Show message indicating login is required
      setCartMessage('Inicia sesión para añadir productos al carrito');
      setShowCartMessage(true);
      return;
    }
    
    // Use context to add to cart
    const success = await addToCart(component);
    
    if (success) {
      // Show confirmation message
      setCartMessage(`${component.name} añadido al carrito`);
      setShowCartMessage(true);
    } else {
      // Show error message
      setCartMessage('Error al añadir al carrito');
      setShowCartMessage(true);
    }
  };

  // Usar las categorías predefinidas definidas fuera del componente

  // Function to determine the category of a component
  const determineCategory = (component) => {
    // Check name and category to determine the type
    const name = (component.name || '').toLowerCase();
    const category = (component.category || '').toLowerCase();
    
    if (name.includes('placa') || name.includes('motherboard') || category.includes('placa') || category.includes('motherboard')) {
      return 'motherboard';
    }
    if (name.includes('procesador') || name.includes('cpu') || name.includes('ryzen') || name.includes('intel') || category.includes('procesador') || category.includes('cpu')) {
      return 'cpu';
    }
    if (name.includes('gráfica') || name.includes('gpu') || name.includes('geforce') || name.includes('radeon') || category.includes('gráfica') || category.includes('gpu')) {
      return 'gpu';
    }
    if (name.includes('ram') || name.includes('memoria') || category.includes('ram') || category.includes('memoria')) {
      return 'ram';
    }
    if (name.includes('disco') || name.includes('ssd') || name.includes('hdd') || name.includes('storage') || category.includes('disco') || category.includes('almacenamiento')) {
      return 'storage';
    }
    if (name.includes('refrigera') || name.includes('cooling') || name.includes('ventilador') || name.includes('fan') || category.includes('refrigera') || category.includes('cooling')) {
      return 'cooling';
    }
    if (name.includes('fuente') || name.includes('alimentación') || name.includes('psu') || name.includes('power') || category.includes('fuente') || category.includes('alimentación')) {
      return 'psu';
    }
    
    return 'other';
  };
  
  // Group components by category
  const groupedComponents = {};
  
  components.forEach(component => {
    const category = determineCategory(component);
    if (!groupedComponents[category]) {
      groupedComponents[category] = [];
    }
    groupedComponents[category].push(component);
  });
  
  // Initialize carousel indexes if not already set
  useEffect(() => {
    if (components.length > 0 && Object.keys(carouselIndexes).length === 0) {
      const initialIndexes = {};
      Object.keys(groupedComponents).forEach(category => {
        initialIndexes[category] = 0;
      });
      setCarouselIndexes(initialIndexes);
    }
  }, [components, carouselIndexes, groupedComponents]);

  if (loading) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '80vh' }}>
        <CircularProgress />
      </Box>
    );
  }

  if (error) {
    return (
      <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '80vh' }}>
        <Typography variant="h6" color="error">{error}</Typography>
      </Box>
    );
  }

  return (
    <Container maxWidth="lg" sx={{ py: 4 }}>
      <Box sx={{ mb: 4 }}>
        <Typography variant="h4" component="h1" gutterBottom>
          Componentes
        </Typography>
        <Typography variant="body1" color="text.secondary" sx={{ mb: 2 }}>
          Descubre nuestra selección de componentes de alta calidad para tu ordenador
        </Typography>
        <Divider />
      </Box>
      {/* Cart message snackbar */}
      {showCartMessage && (
        <Box
          sx={{
            position: 'fixed',
            bottom: 20,
            left: '50%',
            transform: 'translateX(-50%)',
            backgroundColor: isAuthenticated ? 'success.main' : 'warning.main',
            color: 'white',
            py: 1,
            px: 3,
            borderRadius: 2,
            zIndex: 9999,
            display: 'flex',
            alignItems: 'center',
            gap: 1
          }}
        >
          {!isAuthenticated && <LoginIcon />}
          <Typography variant="body2">{cartMessage}</Typography>
        </Box>
      )}
      {Object.entries(groupedComponents).map(([category, items]) => {
        // Only show categories that have components
        if (items.length === 0) return null;
        
        // Calculate carousel indexes and pagination
        const startIndex = carouselIndexes[category] || 0;
        const hasMoreItems = startIndex + maxItemsPerPage < items.length;
        const hasPreviousItems = startIndex > 0;
        
        // Functions to navigate the carousel
        const handleNext = () => {
          setCarouselIndexes({
            ...carouselIndexes,
            [category]: startIndex + maxItemsPerPage
          });
        };
        
        const handlePrevious = () => {
          setCarouselIndexes({
            ...carouselIndexes,
            [category]: Math.max(0, startIndex - maxItemsPerPage)
          });
        };
        
        // Get only the components that will be shown on the current page
        const visibleItems = items.slice(startIndex, startIndex + maxItemsPerPage);
        
        return (
          <Box key={category} sx={{ mb: 6 }}>
            <Typography variant="h5" component="h2" sx={{ mb: 2 }}>
              {categories[category] || 'Otros Componentes'}
            </Typography>
            
            <Box sx={{ display: 'flex', justifyContent: 'flex-end', mb: 1 }}>
              <IconButton 
                onClick={handlePrevious} 
                disabled={!hasPreviousItems}
                color="primary"
                size="small"
              >
                <ArrowBackIcon />
              </IconButton>
              <IconButton 
                onClick={handleNext} 
                disabled={!hasMoreItems}
                color="primary"
                size="small"
              >
                <ArrowForwardIcon />
              </IconButton>
            </Box>
            
            <Grid container spacing={2}>
              {visibleItems.map((component) => (
                <Grid item xs={12} sm={6} md={3} key={component._id}>
                  <Card sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                    <CardMedia
                      component="img"
                      height="160"
                      image={component.image || 'https://via.placeholder.com/300x200?text=No+Image'}
                      alt={component.name}
                      sx={{ objectFit: 'contain', p: 1 }}
                    />
                    <CardContent sx={{ pt: 1, pb: 1 }}>
                      <Typography variant="subtitle1" component="div" sx={{ fontWeight: 'medium', mb: 0.5, minHeight: '2.5em', wordWrap: 'break-word' }}>
                        {component.name}
                      </Typography>
                      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                        {component.discountPrice ? (
                          <Box sx={{ display: 'flex', alignItems: 'center' }}>
                            <Typography variant="h6" color="error.main" sx={{ fontWeight: 'bold' }}>
                              {component.discountPrice.toFixed(2)}€
                            </Typography>
                            <Typography 
                              variant="body2" 
                              sx={{ 
                                textDecoration: 'line-through', 
                                color: 'text.secondary',
                                ml: 1
                              }}
                            >
                              {component.price.toFixed(2)}€
                            </Typography>
                          </Box>
                        ) : (
                          <Typography variant="h6">
                            {component.price.toFixed(2)}€
                          </Typography>
                        )}
                      </Box>
                    </CardContent>
                    <Box sx={{ mt: 'auto', p: 1, pt: 0, display: 'flex', justifyContent: 'space-between' }}>
                      <Button 
                        size="small" 
                        variant="outlined"
                        onClick={() => {
                          setSelectedComponent(component);
                          setOpenSpecsDialog(true);
                        }}
                        startIcon={<InfoIcon />}
                        sx={{ color: 'black' }}
                      >
                        Detalles
                      </Button>
                      <Button 
                        size="small" 
                        variant="contained" 
                        color="secondary"
                        onClick={() => handleAddToCart(component)}
                        startIcon={<AddShoppingCartIcon />}
                      >
                        Añadir
                      </Button>
                    </Box>
                  </Card>
                </Grid>
              ))}
            </Grid>
          </Box>
        );
      })}
      
      {/* Dialog to show component specifications */}
      <Dialog
        open={openSpecsDialog}
        onClose={() => setOpenSpecsDialog(false)}
        maxWidth="md"
        fullWidth
      >
        {selectedComponent && (
          <>
            <DialogTitle sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <Typography variant="h6">{selectedComponent.name}</Typography>
              <IconButton onClick={() => setOpenSpecsDialog(false)}>
                <CloseIcon />
              </IconButton>
            </DialogTitle>
            <DialogContent dividers>
              <Grid container spacing={3}>
                <Grid item xs={12} md={5}>
                  <Box sx={{ position: 'relative' }}>
                    <CardMedia
                      component="img"
                      image={selectedComponent.image || 'https://via.placeholder.com/400x300?text=No+Image'}
                      alt={selectedComponent.name}
                      sx={{ 
                        width: '100%', 
                        objectFit: 'contain',
                        borderRadius: 1,
                        mb: 2
                      }}
                    />
                    {selectedComponent.discountPrice && (
                      <Box
                        sx={{
                          position: 'absolute',
                          top: 10,
                          right: 10,
                          backgroundColor: 'error.main',
                          color: 'white',
                          py: 0.5,
                          px: 1,
                          borderRadius: 1,
                          fontWeight: 'bold'
                        }}
                      >
                        {Math.round((1 - selectedComponent.discountPrice / selectedComponent.price) * 100)}% OFF
                      </Box>
                    )}
                  </Box>
                  <Box sx={{ display: 'flex', justifyContent: 'center', mb: 2 }}>
                    {selectedComponent.discountPrice ? (
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Typography variant="h5" color="error.main" sx={{ fontWeight: 'bold' }}>
                          {selectedComponent.discountPrice.toFixed(2)}€
                        </Typography>
                        <Typography variant="body1" color="text.secondary" sx={{ textDecoration: 'line-through' }}>
                          {selectedComponent.price.toFixed(2)}€
                        </Typography>
                      </Box>
                    ) : (
                      <Typography variant="h5">
                        {selectedComponent.price.toFixed(2)}€
                      </Typography>
                    )}
                  </Box>
                  <Button 
                    variant="contained" 
                    color="secondary" 
                    fullWidth
                    startIcon={<AddShoppingCartIcon />}
                    onClick={() => {
                      handleAddToCart(selectedComponent);
                      setOpenSpecsDialog(false);
                    }}
                    disabled={selectedComponent.stock <= 0}
                  >
                    Añadir al carrito
                  </Button>
                </Grid>
                <Grid item xs={12} md={7}>
                  <Typography variant="h6" gutterBottom>
                    <TableRow>
                      <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                        Categoría
                      </TableCell>
                      <TableCell>{getCategoryName(determineCategory(selectedComponent))}</TableCell>
                    </TableRow>
                  )}
                  {selectedComponent.brand && (
                    <TableRow>
                      <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                        Marca
                      </TableCell>
                      <TableCell>{selectedComponent.brand}</TableCell>
                    </TableRow>
                  )}
                  {selectedComponent.model && (
                    <TableRow>
                      <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                        Modelo
                      </TableCell>
                      <TableCell>{selectedComponent.model}</TableCell>
                    </TableRow>
                  )}
                  {selectedComponent.specs && Object.entries(selectedComponent.specs).map(([key, value]) => {
                    // Translate keys to more user-friendly terms
                    let displayKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                    
                    // Mapping of technical terms to more user-friendly terms
                    const keyMappings = {
                      'Form factor': 'Forma',
                      'Form_factor': 'Forma',
                      'Chipset': 'Chipset',
                      'Ram_slots': 'Huecos de RAM',
                      'Max_ram': 'RAM máxima',
                      'Max ram': 'RAM máxima',
                      'Socket': 'Socket',
                      'Cores': 'Núcleos',
                      'Threads': 'Hilos',
                      'Base_clock': 'Frecuencia base',
                      'Base clock': 'Frecuencia base',
                      'Boost_clock': 'Frecuencia turbo',
                      'Boost clock': 'Frecuencia turbo',
                      'Tdp': 'TDP',
                      'Memory_type': 'Tipo de memoria',
                      'Memory type': 'Tipo de memoria',
                      'Memory_speed': 'Velocidad de memoria',
                      'Memory speed': 'Velocidad de memoria',
                      'Capacity': 'Capacidad',
                      'Interface': 'Interfaz',
                      'Read_speed': 'Velocidad de lectura',
                      'Read speed': 'Velocidad de lectura',
                      'Write_speed': 'Velocidad de escritura',
                      'Write speed': 'Velocidad de escritura',
                      'Rpm': 'RPM',
                      'Cache': 'Caché',
                      'Wattage': 'Potencia',
                      'Efficiency': 'Eficiencia',
                      'Modular': 'Modular',
                      'Size': 'Tamaño',
                      'Fans': 'Ventiladores',
                      'Rgb': 'RGB',
                      'Noise_level': 'Nivel de ruido',
                      'Noise level': 'Nivel de ruido',
                      'Airflow': 'Flujo de aire',
                      'Speed': 'Velocidad',
                      'Channels': 'Canales',
                      'Frequency': 'Frecuencia',
                      'Latency': 'Latencia',
                      'Voltage': 'Voltaje',
                      'Height': 'Altura',
                      'Width': 'Ancho',
                      'Depth': 'Profundidad',
                      'Weight': 'Peso',
                      'Color': 'Color',
                      'Material': 'Material',
                      'Fan_size': 'Tamaño del ventilador',
                      'Fan size': 'Tamaño del ventilador',
                      'Fan_count': 'Número de ventiladores',
                      'Fan count': 'Número de ventiladores',
                      'Fan_speed': 'Velocidad del ventilador',
                      'Fan speed': 'Velocidad del ventilador',
                      'Noise': 'Ruido',
                      'Ports': 'Puertos',
                      'Wireless': 'Inalámbrico',
                      'Bluetooth': 'Bluetooth',
                      'Backlit': 'Retroiluminado',
                      'Switches': 'Interruptores',
                      'Layout': 'Distribución',
                      'Resolution': 'Resolución',
                      'Response_time': 'Tiempo de respuesta',
                      'Response time': 'Tiempo de respuesta',
                      'Panel_type': 'Tipo de panel',
                      'Panel type': 'Tipo de panel',
                      'Refresh_rate': 'Tasa de refresco',
                      'Refresh rate': 'Tasa de refresco',
                      'Aspect_ratio': 'Relación de aspecto',
                      'Aspect ratio': 'Relación de aspecto',
                      'Connectivity': 'Conectividad',
                      'Features': 'Características',
                      'Warranty': 'Garantía'
                    };
                    
                    // Use mapped key if available
                    displayKey = keyMappings[displayKey] || keyMappings[key] || displayKey;
                    
                    return (
                      <TableRow key={key}>
                        <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                          {displayKey}
                        </TableCell>
                        <TableCell>{value}</TableCell>
                      </TableRow>
                    );
                  })}
                  <TableRow>
                    <TableCell component="th" scope="row" sx={{ fontWeight: 'bold' }}>
                      Stock
                    </TableCell>
                    <TableCell>
                      {selectedComponent.stock > 0 ? `${selectedComponent.stock} unidades disponibles` : 'Agotado'}
                    </TableCell>
                  </TableRow>
                </TableBody>
              </Table>
            </TableContainer>
            {selectedComponent.description && (
              <Box sx={{ mt: 2 }}>
                <Typography variant="body1" gutterBottom sx={{ fontWeight: 'bold' }}>
                  Descripción:
                </Typography>
                <Typography variant="body2">
                  {selectedComponent.description}
                </Typography>
              </Box>
            )}
          </Grid>
        </Grid>
      </DialogContent>
    </>
  )}
</Dialog>
    </Container>
  );
};

// Function to get the readable name of the category
const getCategoryName = (category) => {
  // Use the predefined categories we already have in the component
  return categories[category] || 'Otros Componentes';
};

export default ComponentsPage;
